var LoadingUI=function(t){function e(){t.call(this),this.createView()}__extends(e,t);var i=(__define,e),n=i.prototype;return n.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},n.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},n.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},n.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},n.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},n.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},n.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},n.createGameScene=function(){var t=new MapTest;this.addChild(t)},e}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var one;!function(t){function e(t,e){return Math.floor(Math.random()*(e-t+1))+t}t.randomInt=e}(one||(one={}));var one;!function(t){var e=function(t){function e(){t.call(this)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.execute=function(t){var e=puremvc.Facade.getInstance("Map"),t=new puremvc.Notification("CREATE_BULLET",t.getBody());e.notifyObservers(t)},e}(puremvc.SimpleCommand);t.CreateBulletCMD=e,egret.registerClass(e,"one.CreateBulletCMD")}(one||(one={}));var one;!function(t){var e=function(e){function i(){e.call(this)}__extends(i,e);var n=(__define,i),s=n.prototype;return s.execute=function(e){this.facade().retrieveProxy(t.MapVO.NAME)},i}(puremvc.SimpleCommand);t.MapInitCommand=e,egret.registerClass(e,"one.MapInitCommand")}(one||(one={}));var one;!function(t){t.BUTTONS=[10,11,12,13,14,15,16,17]}(one||(one={}));var one;!function(t){var e=function(e){function i(){var t=this;e.call(this),this.isLeft=!1,this.isUp=!1,this.isRight=!1,this.isDown=!1,this.mapButtons={},this.downKeys=[],this.onDown=function(e){var n=e.keyCode,s=t.mapButtons[n];if(s){var r=t.downKeys.indexOf(s);if(r>=0)return;t.downKeys.push(s)}else switch(n){case i.leftCode:t.isLeft=!0;break;case i.upCode:t.isUp=!0;break;case i.rightCode:t.isRight=!0;break;case i.downCode:t.isDown=!0;break;default:return}t.onChange()},this.onUp=function(e){var n=e.keyCode,s=t.mapButtons[n];if(s){var r=t.downKeys.indexOf(s);if(!(r>=0))return;t.downKeys.splice(r,1)}else switch(n){case i.leftCode:t.isLeft=!1;break;case i.upCode:t.isUp=!1;break;case i.rightCode:t.isRight=!1;break;case i.downCode:t.isDown=!1;break;default:return}t.onChange()}}__extends(i,e);var n=(__define,i),s=n.prototype;return s.init=function(e,n){i.upCode=e[0],i.downCode=e[1],i.leftCode=e[2],i.rightCode=e[3],this.buttons=n;for(var s=0;s<n.length;s++)this.mapButtons[n[s]]=t.BUTTONS[s];window.addEventListener("keydown",this.onDown),window.addEventListener("keyup",this.onUp)},s.onChange=function(){var e=[];this.isUp?this.isDown||e.push(2):this.isDown&&e.push(3),this.isLeft?this.isRight||e.push(0):this.isRight&&e.push(1),t.OptionEvent.dispatchOptionEvent(this,t.OptionEvent.OPTION_CHANGE,e,this.downKeys)},i.leftCode=65,i.upCode=87,i.rightCode=68,i.downCode=83,i}(egret.EventDispatcher);t.KeyBoardCtr=e,egret.registerClass(e,"one.KeyBoardCtr")}(one||(one={}));var one;!function(t){var e=function(e){function i(){e.call(this),this.keyCtr=new t.KeyBoardCtr,this.touchCtr=new t.TouchCtr}__extends(i,e);var n=(__define,i),s=n.prototype;return s.init=function(e){this.keyCtr.init([87,83,65,68],[74,75]),this.touchCtr.init(e),this.keyCtr.addEventListener(t.OptionEvent.OPTION_CHANGE,this.onHander,this),this.touchCtr.addEventListener(t.OptionEvent.OPTION_CHANGE,this.onHander,this)},s.onHander=function(t){this.dispatchEvent(t)},s.start=function(){},s.stop=function(){},i.getInstance=function(){return null==i.instance&&(i.instance=new i),i.instance},i}(egret.EventDispatcher);t.OptionCtr=e,egret.registerClass(e,"one.OptionCtr")}(one||(one={}));var one;!function(t){var e=function(t){function e(e){t.call(this,e)}__extends(e,t);var i=(__define,e);i.prototype;return e.dispatchOptionEvent=function(t,i,n,s){if(!t.hasEventListener(i))return!0;var r=egret.Event.create(e,i);r.directions=n,r.buttons=s;var a=t.dispatchEvent(r);return egret.Event.release(r),a},e.OPTION_CHANGE="optionChange",e}(egret.Event);t.OptionEvent=e,egret.registerClass(e,"one.OptionEvent")}(one||(one={}));var one;!function(t){var e=function(e){function i(){var t=this;e.call(this),this.dicX=0,this.dicY=0,this.dicR=80,this.btnX=0,this.btnY=0,this.btnR=80,this.horizontalDirect=0,this.verticalDirect=0,this.horizontalBtn=0,this.verticalBtn=0,this.dircPointID=0,this.btnPointID=0,this.onMove=function(e){e.touchPointID>0?t.dircPointID==e.touchPointID?t.setDirection(e.localX,e.localY):t.btnPointID==e.touchPointID&&t.setBtn(e.localX,e.localY):t.dircPointID>0?t.setDirection(e.localX,e.localY):t.setBtn(e.localX,e.localY)},this.onDown=function(e){t.isInDirection(e.localX,e.localY)&&0==t.dircPointID&&(t.dircPointID=Math.max(e.touchPointID,1),t.setDirection(e.localX,e.localY)),t.isInButton(e.localX,e.localY)&&0==t.btnPointID&&(t.btnPointID=Math.max(e.touchPointID,1),t.setBtn(e.localX,e.localY))},this.onUp=function(e){e.touchPointID>0?t.dircPointID==e.touchPointID?(t.verticalDirect=0,t.horizontalDirect=0,t.dircPointID=0,t.onChange()):t.btnPointID==e.touchPointID&&(t.verticalBtn=0,t.horizontalBtn=0,t.btnPointID=0,t.onChange()):(t.verticalDirect=0,t.horizontalDirect=0,t.dircPointID=0,t.verticalBtn=0,t.horizontalBtn=0,t.btnPointID=0,t.onChange())}}__extends(i,e);var n=(__define,i),s=n.prototype;return s.init=function(t){var e=1.2*this.dicR;this.dicX=e,this.dicY=t.stage.stageHeight-e;var i=new egret.Shape;i.graphics.beginFill(16711680),i.graphics.drawCircle(this.dicR,this.dicR,this.dicR),i.graphics.endFill(),t.addChild(i),i.x=this.dicX-this.dicR,i.y=this.dicY-this.dicR,this.btnX=t.stage.$stageWidth-e,this.btnY=t.stage.stageHeight-e;var i=new egret.Shape;i.graphics.beginFill(16711680),i.graphics.drawCircle(this.btnR,this.btnR,this.btnR),i.graphics.endFill(),t.addChild(i),i.x=this.btnX-this.btnR,i.y=this.btnY-this.btnR,t.touchEnabled=!0,t.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onDown,this),t.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onMove,this),t.addEventListener(egret.TouchEvent.TOUCH_END,this.onUp,this),t.addEventListener(egret.TouchEvent.TOUCH_CANCEL,this.onUp,this),t.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onUp,this)},s.isInButton=function(t,e){return this.isInCircle(this.btnX,this.btnY,t,e,2*this.btnR)},s.isInDirection=function(t,e){return this.isInCircle(this.dicX,this.dicY,t,e,2*this.dicR)},s.isInCircle=function(t,e,i,n,s){return s*s>(t-i)*(t-i)+(e-n)*(e-n)},s.setDirection=function(t,e){var i=!1,n=0;t>this.dicX+this.dicR/2?n=1:t<this.dicX-this.dicR/2&&(n=-1),this.horizontalDirect!=n&&(i=!0,this.horizontalDirect=n);var n=0;e>this.dicY+this.dicR/2?n=1:e<this.dicY-this.dicR/2&&(n=-1),this.verticalDirect!=n&&(i=!0,this.verticalDirect=n),i&&this.onChange()},s.setBtn=function(t,e){var i=!1,n=0;t>this.btnX+this.btnR/2?n=1:t<this.btnX-this.btnR/2&&(n=-1),this.horizontalBtn!=n&&(i=!0,this.horizontalBtn=n);var n=0;e>this.btnY+this.btnR/2?n=1:e<this.btnY-this.btnR/2&&(n=-1),this.verticalBtn!=n&&(i=!0,this.verticalBtn=n),i&&this.onChange()},s.onChange=function(){var e=[];this.horizontalBtn>0?(e.push(t.BUTTONS[0]),e.push(t.BUTTONS[1])):this.verticalBtn<0?e.push(t.BUTTONS[1]):this.verticalBtn>0&&e.push(t.BUTTONS[0]);var i=[];this.verticalDirect<0?i.push(2):this.verticalDirect>0&&i.push(3),this.horizontalDirect<0?i.push(0):this.horizontalDirect>0&&i.push(1),t.OptionEvent.dispatchOptionEvent(this,t.OptionEvent.OPTION_CHANGE,i,e)},i}(egret.EventDispatcher);t.TouchCtr=e,egret.registerClass(e,"one.TouchCtr")}(one||(one={}));var Effect=function(t){function e(e,i,n,s,r){t.call(this),this.skeletonData=e,this.textureData=i,this.texture=n,this.armatureName=s,this.animationName=r}__extends(e,t);var i=(__define,e),n=i.prototype;return n.initRoot=function(){var t=this,e=new egret.DisplayObjectContainer;this.addChild(e);var i=new dragonBones.EgretFactory;i.addSkeletonData(dragonBones.DataParser.parseDragonBonesData(this.skeletonData)),i.addTextureAtlas(new dragonBones.EgretTextureAtlas(this.texture,this.textureData));var n=i.buildArmature(this.armatureName),s=n.getDisplay();dragonBones.WorldClock.clock.add(n),e.addChild(s),n.animation.gotoAndPlay(this.animationName,0),n.addEventListener(dragonBones.AnimationEvent.COMPLETE,function(e){dragonBones.WorldClock.clock.remove(n),t.dispatchEvent(e),t.parent.removeChild(t)},this)},e.start=function(){egret.Ticker.getInstance().register(function(t){return dragonBones.WorldClock.clock.advanceTime(t/1e3),!0},this)},e}(egret.DisplayObjectContainer);egret.registerClass(Effect,"Effect");var one;!function(t){var e=function(){function t(){this.width=0,this.height=0}var e=(__define,t),i=e.prototype;return i.toString=function(){return"width:"+this.width+" height:"+this.height+" centerX:"+this.centerX+" centerY:"+this.centerY+" type:"+this.type},t}();t.GridVO=e,egret.registerClass(e,"one.GridVO")}(one||(one={}));var one;!function(t){var e=function(t){function e(e){t.call(this),this.vo=new e,this.vo.item=this}__extends(e,t);var i=(__define,e);i.prototype;return e}(egret.DisplayObjectContainer);t.MapItem=e,egret.registerClass(e,"one.MapItem")}(one||(one={}));var one;!function(t){var e=function(){function t(){}var e=(__define,t);e.prototype;return t.BUILD=1,t.BULLET=2,t}();t.ItemType=e,egret.registerClass(e,"one.ItemType");var i=function(){function t(){}var e=(__define,t);e.prototype;return t.FRIEND=1,t.ENEMY=-1,t.NEUTRAL=0,t}();t.SideType=i,egret.registerClass(i,"one.SideType");var n=function(){function t(){this.blockSizes=[],this.x=0,this.y=0,this.rotation=0,this.realBlockSizes=[],this._hashId=t.hashCount++}var e=__define,i=t,n=i.prototype;return n.init=function(t,e){this.type=t,this.side=e},n.setBlocks=function(t){this.blockSizes=t,this.changeRotation(this.rotation)},e(n,"hashId",function(){return this._hashId}),n.getBlockSizes=function(){return this.realBlockSizes},n.changeRotation=function(t){this.realBlockSizes=[];for(var e=0;e<this.blockSizes.length;e++){var i=this.blockSizes[e];this.setBlock(i.centerX,i.centerY,i.width,i.height,t)}},n.setBlock=function(t,e,i,n,s){if(0==t&&0==e)return void this.realBlockSizes.push({centerX:0,centerY:0,width:n,height:i});switch((s+360)%360){case 0:return void this.realBlockSizes.push({centerX:t,centerY:e,width:i,height:n});case 180:return void this.realBlockSizes.push({centerX:-t,centerY:-e,width:i,height:n});case 90:return void this.realBlockSizes.push({centerX:-e,centerY:t,width:n,height:i});case 270:return void this.realBlockSizes.push({centerX:e,centerY:-t,width:n,height:i})}var r=Math.sqrt(t*t+e*e),a=Math.acos(e/r);t>0&&(a=2*Math.PI-a);var o=a-s/180*Math.PI;this.realBlockSizes.push({centerX:r*Math.sin(o),centerY:r*Math.cos(o),width:i,height:n})},t.hashCount=1,t}();t.MapItemVO=n,egret.registerClass(n,"one.MapItemVO");var s=function(){function t(t,e,i,n){this.centerX=t,this.centerY=e,this.width=i,this.height=n}var e=(__define,t);e.prototype;return t}();t.BlockVO=s,egret.registerClass(s,"one.BlockVO")}(one||(one={}));var one;!function(t){var e=function(){function e(){this.minSize=10,this.areaWidth=100,this.areaHeight=100,this.totalX=0,this.totalY=0}var i=(__define,e),n=i.prototype;return n.getBuildVO=function(t){return this.mapVO.builds[t]?this.mapVO.builds[t].vo:null},n.getAreaIndex=function(t,e){return t=Math.max(Math.min(t,this.totalX),0),e=Math.max(Math.min(e,this.totalY),0),this.totalX*e+t},n.analysis=function(e){this.mapVO=new t.MapVO;var i=e.width,n=e.height;this.totalX=Math.floor(i/this.areaWidth)+1,this.totalY=Math.floor(n/this.areaHeight)+1},n.buildAdd=function(t){this.addBuildVO(t)},n.getGridsArr=function(e,i){switch(e){case t.ItemType.BUILD:return i==t.SideType.ENEMY?this.mapVO.enemyGrids:i==t.SideType.FRIEND?this.mapVO.friendGrids:this.mapVO.neutralGrids;case t.ItemType.BULLET:return i==t.SideType.ENEMY?this.mapVO.enemyBullets:i==t.SideType.FRIEND?this.mapVO.friendBullets:this.mapVO.neutralBullets;default:return this.mapVO.friendGrids}},n.addBuildVO=function(t){this.mapVO.builds[t.hashId]={vo:t,grids:[]};for(var e=t.getBlockSizes(),i=0;i<e.length;i++){var n=e[i];this.addOneSize(n.centerX+t.x,n.centerY+t.y,n.width,n.height,t.type,t.side,t.hashId)}},n.getAreaIds=function(t,e,i,n){var n=n>0?n:i,s=t-i/2,r=e-n/2,a=Math.floor(s/this.areaWidth),o=Math.floor(r/this.areaHeight);a=Math.max(a,0),o=Math.max(o,0);var h=Math.floor((s+i)/this.areaWidth),d=Math.floor((r+n)/this.areaHeight);h=Math.min(h,this.totalX),d=Math.min(d,this.totalY);for(var c=[],l=a;h>=l;l++)for(var u=o;d>=u;u++)c.push(this.getAreaIndex(l,u));return c},n.addOneSize=function(e,i,n,s,r,a,o){var h=new t.GridVO;h.centerX=e,h.centerY=i,h.width=n,h.height=s,h.hashId=o,h.side=a,this.mapVO.builds[o].grids.push(h);for(var d=this.getAreaIds(e,i,n,s),c=0;c<d.length;c++){var l=d[c],u=this.getGridsArr(r,a);null==u[l]&&(u[l]=[]),u[l].push(h)}},n.buildRemove=function(t){this.removeBuildVO(t)},n.buildRefresh=function(t){this.removeBuildVO(t),this.addBuildVO(t)},n.removeBuildVO=function(t){if(this.mapVO.builds[t.hashId]){for(var e=this.getGridsArr(t.type,t.side),i=this.mapVO.builds[t.hashId].grids,n=0;n<i.length;n++)for(var s=i[n],r=this.getAreaIds(s.centerX,s.centerY,s.width,s.height),a=0;a<r.length;a++){var o=e[r[a]],h=o.indexOf(s);h>=0&&o.splice(h,1)}return this.mapVO.builds[t.hashId]=null,!0}return!1},n.getBlockArr=function(e,i){var n=[];switch(e){case t.ItemType.BUILD:n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.FRIEND)),n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.ENEMY)),n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.NEUTRAL));break;case t.ItemType.BULLET:i!=t.SideType.FRIEND&&(n.push(this.getGridsArr(t.ItemType.BULLET,t.SideType.FRIEND)),n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.FRIEND))),i!=t.SideType.ENEMY&&(n.push(this.getGridsArr(t.ItemType.BULLET,t.SideType.ENEMY)),n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.ENEMY))),i!=t.SideType.NEUTRAL&&(n.push(this.getGridsArr(t.ItemType.BULLET,t.SideType.NEUTRAL)),n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.NEUTRAL)))}return n},n.isBlocked=function(t,e,i,n,s,r){for(var a=0;a<i.length;a++){var o=i[a],h=this.isBlocked111111(o.centerX+t,o.centerY+e,o.width,o.height,n,s,r);if(0!=h)return h}return 0},n.isBlocked111111=function(t,e,i,n,s,r,a){for(var o=this.getAreaIds(t,e,i,n),h=this.getBlockArr(s,r),d=0;d<o.length;d++)for(var c=0;c<h.length;c++)for(var l=h[c][o[d]],u=0;l&&u<l.length;u++){var p=l[u];if(a!=p.hashId&&this.isCoincident(t,e,i,n,p.centerX,p.centerY,p.width,p.height))return p.hashId}return 0},n.isCoincident=function(t,e,i,n,s,r,a,o){return 0==n?0==o?this.isTwoCircleCoincident(t,e,i,s,r,a):this.isRectAndCircleCoincident(s,r,a,o,t,e,i):0==o?this.isRectAndCircleCoincident(t,e,i,n,s,r,a):this.isTwoRectCoincident(t,e,i,n,s,r,a,o)},n.isRectAndCircleCoincident=function(t,e,i,n,s,r,a){return Math.abs(t-s)<=(i+a)/2&&Math.abs(e-r)<=(n+a)/2},n.isTwoRectCoincident=function(t,e,i,n,s,r,a,o){return Math.abs(t-s)<=(i+a)/2&&Math.abs(e-r)<=(n+o)/2},n.isTwoCircleCoincident=function(t,e,i,n,s,r){return(i+r)*(i+r)/4>=(t-n)*(t-n)+(e-s)*(e-s)},e}();t.MapProxy=e,egret.registerClass(e,"one.MapProxy")}(one||(one={}));var one;!function(t){var e=function(){function t(){this.friendGrids=[],this.enemyGrids=[],this.neutralGrids=[],this.friendBullets=[],this.enemyBullets=[],this.neutralBullets=[],this.builds={}}var e=(__define,t);e.prototype;return t.NAME="mapVO",t}();t.MapVO=e,egret.registerClass(e,"one.MapVO")}(one||(one={}));var one;!function(t){var e=function(e){function i(i,n){e.call(this),this.minX=0,this.minY=0,this.maxX=0,this.maxY=0,this.minX=0,this.minY=0,this.maxX=i,this.maxY=n;var s=puremvc.Facade.getInstance("Map");s.registerCommand("CreateBullet",t.CreateBulletCMD);var r=new MapMediator(this);s.registerMediator(r),this.groundLayer=new egret.DisplayObjectContainer,this.roleLayer=new egret.DisplayObjectContainer,this.bulletLayer=new egret.DisplayObjectContainer,this.effectLayer=new egret.DisplayObjectContainer,this.addChild(this.groundLayer),this.addChild(this.roleLayer),this.addChild(this.bulletLayer),this.addChild(this.effectLayer)}__extends(i,e);var n=(__define,i),s=n.prototype;return s.init=function(){this.mapProxy=new t.MapProxy,this.mapProxy.analysis({width:this.stage.stageWidth,height:this.stage.stageHeight});for(var e=0;16>e;e++){var i=new t.Enemy;this.roleLayer.addChild(i),i.vo.x=180*(e%6)+150,i.vo.y=180*Math.floor(e/6)+60,this.mapProxy.buildAdd(i.vo),i.updateView()}for(var e=0;16>e;e++){var n=new t.Stone;this.roleLayer.addChild(n),n.vo.x=180*(e%6)+60,n.vo.y=180*Math.floor(e/6)+60+90,this.mapProxy.buildAdd(n.vo),n.updateView()}var s=this.role=new t.Role;this.roleLayer.addChild(s),s.vo.x=870,s.vo.y=500,this.mapProxy.buildAdd(s.vo),s.init(),s.updateView(),egret.startTick(this.loop,this),egret.setInterval(function(){},this,5e3),Effect.start()},s.createBullet=function(){var e=new t.Bullet(12,1,t.SideType.FRIEND);this.addChild(e),e.vo.x=this.role.x+this.role.width/2,e.vo.y=this.role.y+this.role.height/2,e.setStepX(this.role.getDicX()),e.setStepY(this.role.getDicY())},s.addBullet=function(t){this.bulletLayer.addChild(t),this.mapProxy.buildAdd(t.vo)},s.addToGround=function(t){this.groundLayer.addChild(t)},s.addToEffect=function(t){this.effectLayer.addChild(t)},s.addBuild=function(t){this.roleLayer.addChild(t),this.mapProxy.buildAdd(t.vo)},s.removeBuild=function(t){t.parent.removeChild(t),this.mapProxy.buildRemove(t.vo)},s.removeVO=function(t){this.mapProxy.buildRemove(t.vo)},s.loop=function(e){for(var i=0;i<this.roleLayer.numChildren;i++){var n=this.roleLayer.getChildAt(i),s=n.vo;this.mapProxy.getBuildVO(s.hashId)&&(n instanceof t.Stone||s.type==t.ItemType.BUILD&&(0!=n.getStepX()||0!=n.getStepY()?this.mapProxy.isBlocked(s.x+n.getStepX(),s.y+n.getStepY(),s.getBlockSizes(),s.type,s.side,s.hashId)?this.mapProxy.isBlocked(s.x+n.getStepX(),s.y,s.getBlockSizes(),s.type,s.side,s.hashId)?this.mapProxy.isBlocked(s.x,s.y+n.getStepY(),s.getBlockSizes(),s.type,s.side,s.hashId)||(n.updateY(),n.updateStep(),s.y=Math.min(Math.max(s.y,this.minY+s.minY),this.maxY-s.maxY),this.mapProxy.buildRefresh(s),n.updateView()):(n.updateX(),n.updateStep(),s.x=Math.min(Math.max(s.x,this.minX+s.minX),this.maxX-s.maxX),this.mapProxy.buildRefresh(s),n.updateView()):(n.updateX(),n.updateY(),n.updateStep(),s.x=Math.min(Math.max(s.x,this.minX+s.minX),this.maxX-s.maxX),s.y=Math.min(Math.max(s.y,this.minY+s.minY),this.maxY-s.maxY),this.mapProxy.buildRefresh(s),n.updateView()):n.updateStep()))}for(var i=0;i<this.bulletLayer.numChildren;i++){var n=this.bulletLayer.getChildAt(i),r=n.vo;if(this.mapProxy.getBuildVO(r.hashId)&&r.type==t.ItemType.BULLET){var a=this.mapProxy.isBlocked(r.x+n.getStepX(),r.y+n.getStepY(),r.getBlockSizes(),r.type,r.side,r.hashId);if(a){var o=this.mapProxy.getBuildVO(a);if(r.attack>o.defense){o.health-=r.attack-o.defense;var h=o.item;o.health<=0?h.dead():(h.beAttack(),n.dead())}}else n.updateX(),n.updateY(),n.updateStep(),r.x+r.maxY<this.minX||r.x-r.minY>this.maxX||r.y+r.maxY<this.minY||r.y-r.minY>this.maxY?n.disappear():(this.mapProxy.buildRefresh(r),n.updateView())}}return!1},i}(egret.DisplayObjectContainer);t.Map=e,egret.registerClass(e,"one.Map")}(one||(one={}));var MapMediator=function(t){function e(i){t.call(this,e.NAME,i)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.listNotificationInterests=function(){return["CREATE_BULLET","ADD_TO_GROUND","ADD_TO_EFFECT","ADD_TO_BUILD","REMOVE_FROM_BUILD","REMOVE_VO"]},n.handleNotification=function(t){if("CREATE_BULLET"==t.getName()){var e=this.getViewComponent();e.addBullet(t.getBody())}else if("ADD_TO_GROUND"==t.getName()){var e=this.getViewComponent();e.addToGround(t.getBody())}else if("ADD_TO_EFFECT"==t.getName()){var e=this.getViewComponent();e.addToEffect(t.getBody())}else if("ADD_TO_BUILD"==t.getName()){var e=this.getViewComponent();e.addBuild(t.getBody())}else if("REMOVE_FROM_BUILD"==t.getName()){var e=this.getViewComponent();e.removeBuild(t.getBody())}else if("REMOVE_VO"==t.getName()){var e=this.getViewComponent();e.removeVO(t.getBody())}},e.NAME="MapMediator",e}(puremvc.Mediator);egret.registerClass(MapMediator,"MapMediator");var one;!function(t){var e=function(t){function e(e){t.call(this),e.armatureName?this.init(RES.getRes(e.name+"_ske_json"),RES.getRes(e.name+"_texture_json"),RES.getRes(e.name+"_texture_png"),e.armatureName,e.animationName):(this.movie=new egret.Bitmap(RES.getRes(e.name)),this.addChild(this.movie)),this.movie.scaleX=e.scaleX,this.movie.scaleY=e.scaleY,this.movie.anchorOffsetX=e.offX,this.movie.anchorOffsetY=e.offY}__extends(e,t);var i=(__define,e),n=i.prototype;return n.changeAnimation=function(t){this.armature.animation.gotoAndPlay(t,0)},n.init=function(t,e,i,n,s){var r=new dragonBones.EgretFactory;r.addSkeletonData(dragonBones.DataParser.parseDragonBonesData(t)),r.addTextureAtlas(new dragonBones.EgretTextureAtlas(i,e));var a=this.armature=r.buildArmature(n),o=this.movie=a.getDisplay();dragonBones.WorldClock.clock.add(a),this.addChild(o),a.animation.gotoAndPlay(s,0);var h=this;a.addEventListener(dragonBones.AnimationEvent.COMPLETE,function(t){h.dispatchEvent(t)},this),a.addEventListener(dragonBones.FrameEvent.ANIMATION_FRAME_EVENT,function(t){h.dispatchEvent(t)},this),a.addEventListener(dragonBones.FrameEvent.MOVEMENT_FRAME_EVENT,function(t){h.dispatchEvent(t)},this)},e}(egret.DisplayObjectContainer);t.Anmiation=e,egret.registerClass(e,"one.Anmiation")}(one||(one={}));var tank;!function(t){var e=function(e){function i(i,n,s){e.call(this,i||t.BaseVO);var r=this.vo;r.initConfig(n,s),this.view=new one.Anmiation(r.resVO),this.addChild(this.view),this.gridLayer=new egret.DisplayObjectContainer,this.addChild(this.gridLayer),this.showGrid()}__extends(i,e);var n=(__define,i),s=n.prototype;return s.showGrid=function(){if("1"==egret.getOption("debug")){this.gridLayer.removeChildren();for(var t=this.vo.getBlockSizes(),e=0;e<t.length;e++){var i=new egret.Shape;i.graphics.beginFill(16777215,.5),i.graphics.drawRect(-t[e].width/2,-t[e].height/2,t[e].width,t[e].height),i.graphics.endFill(),this.gridLayer.addChild(i),i.x=t[e].centerX,i.y=t[e].centerY}}},s.updateView=function(){this.x=this.vo.x,this.y=this.vo.y,this.showGrid()},s.beAttack=function(){var t=RES.getRes("baozhaxiaoguo_ske_json"),e=RES.getRes("baozhaxiaoguo_texture_json"),i=RES.getRes("baozhaxiaoguo_texture_png"),n=new Effect(t,e,i,"baozha","baozha");n.initRoot(),n.x=this.x,n.y=this.y,n.scaleX=n.scaleY=.3;var s=puremvc.Facade.getInstance("Map");s.sendNotification("ADD_TO_EFFECT",n)},s.dead=function(){var t=RES.getRes("baozhaxiaoguo_ske_json"),e=RES.getRes("baozhaxiaoguo_texture_json"),i=RES.getRes("baozhaxiaoguo_texture_png"),n=new Effect(t,e,i,"baozha","baozha");n.initRoot(),n.x=this.x,n.y=this.y,n.scaleX=n.scaleY=.3;var s=puremvc.Facade.getInstance("Map");s.sendNotification("ADD_TO_EFFECT",n),s.sendNotification("REMOVE_FROM_BUILD",this)},s.disappear=function(){var t=puremvc.Facade.getInstance("Map");t.sendNotification("REMOVE_FROM_BUILD",this)},i}(one.MapItem);t.BaseItem=e,egret.registerClass(e,"tank.BaseItem")}(tank||(tank={}));var one;!function(t){var e=function(t){function e(e,i,n){t.call(this,e,i,n),this._stepX=0,this._stepY=0,this._speed=1,this._turningTime=0,this._dicX=0,this._dicY=1}__extends(e,t);var i=(__define,e),n=i.prototype;return n.getStepX=function(){return this._stepX*this._speed},n.getStepY=function(){return this._stepY*this._speed},n.setStepX=function(t){this._stepX=t},n.setStepY=function(t){this._stepY=t},n.updateX=function(){this._turningTime>0||(this.vo.x+=this._stepX*this._speed)},n.updateY=function(){this._turningTime>0||(this.vo.y+=this._stepY*this._speed)},n.updateStep=function(){return this._turningTime>0?void this._turningTime--:void 0},n.getDicX=function(){return this._dicX},n.getDicY=function(){return this._dicY},n.changeDic=function(t,e){this._stepX=t,this._stepY=e;var i=0;0!=t?(this._dicX=t,this._dicY=e,i=0==e?90*-t:1==e?135/(t+2)+45*(e+1)+180:45*t+45*(e+1)+180):0!=e?(this._dicY=e,this._dicX=0,i=90*(e+1)+180):i=this.view.rotation,this.view.rotation=i,this.vo.changeRotation(i)},e}(tank.BaseItem);t.BaseRole=e,egret.registerClass(e,"one.BaseRole")}(one||(one={}));var tank;!function(t){var e=function(e){function i(){e.apply(this,arguments),this.attack=0,this.defense=0,this.health=0,this.mana=0,this.minX=0,this.minY=0,this.maxX=0,this.maxY=0}__extends(i,e);var n=(__define,i),s=n.prototype;return s.initConfig=function(i,n){this.buildId=i;var s=RES.getRes("itemCfg_json")[i];this.resVO=new t.ResourceVO,this.resVO.initConfig(s),this.minX=s.size.range[0],this.minY=s.size.range[1],this.maxX=s.size.range[2],this.maxY=s.size.range[3],this.attack=s.properties.attack||0,this.defense=s.properties.defense||0,this.health=s.properties.health||0,this.mana=s.properties.mana||0;for(var r=s.size.blockSizes,a=[],o=0;o<r.length;o++){var h=new one.BlockVO(r[o][0],r[o][1],r[o][2],r[o][3]);a.push(h)}e.prototype.setBlocks.call(this,a),e.prototype.init.call(this,s.type,n),this.initCfg(s)},s.initCfg=function(t){},i}(one.MapItemVO);t.BaseVO=e,egret.registerClass(e,"tank.BaseVO")}(tank||(tank={}));var one;!function(t){var e=function(e){function i(i,n,s){e.call(this,t.BulletVO,i,s),this._speed=n}__extends(i,e);var n=(__define,i),s=n.prototype;return s.fire=function(){var t=RES.getRes("launcher_ske_json"),e=RES.getRes("launcher_texture_json"),i=RES.getRes("launcher_texture_png"),n=new Effect(t,e,i,"launcher","start");n.initRoot(),n.scaleX=n.scaleY=.4,this.addChild(n);var s=this.localToGlobal(0,0);n.x=s.x,n.y=s.y,n.rotation=this.view.rotation-90;var r=puremvc.Facade.getInstance("Map");r.sendNotification("ADD_TO_EFFECT",n)},s.dead=function(){var t=puremvc.Facade.getInstance("Map");t.sendNotification("REMOVE_VO",this),egret.setTimeout(function(){this.parent.removeChild(this)},this,100)},i}(t.BaseRole);t.Bullet=e,egret.registerClass(e,"one.Bullet")}(one||(one={}));var one;!function(t){var e=function(t){function e(){t.call(this),this.fireInterval=100}__extends(e,t);var i=(__define,e);i.prototype;return e}(tank.BaseVO);t.BulletVO=e,egret.registerClass(e,"one.BulletVO")}(one||(one={}));var one;!function(t){var e=function(e){function i(){e.call(this,t.RoleVO,2,t.SideType.ENEMY),this._deltaThinkTime=0,this._thinkInterval=20,this._deltaFireTime=0,this._fireInterval=20}__extends(i,e);var n=(__define,i),s=n.prototype;return s.updateStep=function(){e.prototype.updateStep.call(this),this.think(),this.checkFire()},s.think=function(){if(this._deltaThinkTime++,this._deltaThinkTime>=this._thinkInterval){this._deltaThinkTime=0,this._thinkInterval=t.randomInt(105,400);var e=t.randomInt(-2,2),i=0,n=0;switch(e){case 2:case-2:n=e/2;break;case 1:case-1:i=e}(this._stepX!=i||this._stepY!=n)&&(this._turningTime=2),this.changeDic(i,n)}},s.checkFire=function(){this._deltaFireTime++,this._deltaFireTime>=this._fireInterval&&(this._deltaFireTime=0,this._fireInterval=t.randomInt(205,600),this.fire())},s.fire=function(){var e=new t.Bullet(this.vo.bulletId,this.vo.bulletSpeed,t.SideType.ENEMY),i=this.view.localToGlobal(0,20);e.vo.x=i.x,e.vo.y=i.y,e.changeDic(this.getDicX(),this.getDicY()),e.updateView();var n=puremvc.Facade.getInstance("Map");n.sendNotification("CREATE_BULLET",e),e.fire()},i}(t.BaseRole);t.Enemy=e,egret.registerClass(e,"one.Enemy")}(one||(one={}));var tank;!function(t){var e=function(){function t(){this.offX=0,this.offY=0,this.scaleX=1,this.scaleY=1}var e=(__define,t),i=e.prototype;return i.initConfig=function(t){this.offX=t.res.offPoint[0]||0,this.offY=t.res.offPoint[1]||0,this.scaleX=t.res.offPoint[2]||1,this.scaleY=t.res.offPoint[3]||1,this.name=t.res.name,this.armatureName=t.res.armature,this.animationName=t.res.animation},t}();t.ResourceVO=e,egret.registerClass(e,"tank.ResourceVO")}(tank||(tank={}));var one;!function(t){var e=function(e){function n(){e.call(this,t.RoleVO,1,t.SideType.FRIEND),this.isAttack=!1,this.isJump=!1,this.fireCount=0,this.shadowCount=30,this.shadowTimes=15,this._speed=2}__extends(n,e);var s=(__define,n),r=s.prototype;return r.init=function(){var e=this,i=function(i){for(var n=i.directions,s=0,r=0,a=0;a<n.length;a++)switch(n[a]){case 0:s--;break;case 1:s++;break;case 2:r--;break;case 3:r++}0==e._stepX&&0==e._stepY&&(e._turningTime=6),e.changeDic(s,r),e.isAttack=!1,e.isJump=!1;var o=i.buttons;for(a=0;a<o.length;a++)switch(o[a]){case t.BUTTONS[0]:e.isAttack=!0;break;case t.BUTTONS[1]:e.isJump=!0}};t.OptionCtr.getInstance().addEventListener(t.OptionEvent.OPTION_CHANGE,i,this)},r.createBullet=function(){var e=new t.Bullet(this.vo.bulletId,this.vo.bulletSpeed,t.SideType.FRIEND),i=this.view.localToGlobal(0,20);e.vo.x=i.x,e.vo.y=i.y,e.changeDic(this.getDicX(),this.getDicY()),e.updateView();var n=puremvc.Facade.getInstance("Map");n.sendNotification("CREATE_BULLET",e),e.fire(),this.view.changeAnimation("attack"),this.view.addEventListener(dragonBones.AnimationEvent.COMPLETE,function(t){this.view.changeAnimation("\bwalk")},this)},r.updateStep=function(){if(e.prototype.updateStep.call(this),this.fireCount<=0?this.isAttack&&(this.fireCount=this.vo.fireInterval,this.createBullet()):this.fireCount--,this.shadowCount++,this.shadowCount>=this.shadowTimes){this.shadowCount=0;var t=this.getShadow();t.rotation=this.view.rotation,t.x=this.x,t.y=this.y,t.show();var i=puremvc.Facade.getInstance("Map");i.sendNotification("ADD_TO_GROUND",t)}},r.getShadow=function(){if(i.shadows.length)return i.shadows.pop();var t=new i;return t},r.jump=function(){},r.run=function(){},r.down=function(){},r.setDic=function(t,e){},n}(t.BaseRole);t.Role=e,egret.registerClass(e,"one.Role");var i=function(t){function e(){t.call(this),this.shadow=new egret.Bitmap(RES.getRes("shadow_png")),this.addChild(this.shadow),this.shadow.anchorOffsetX=this.shadow.width/2,this.shadow.anchorOffsetY=this.shadow.height/2,this.shadow.scaleX=this.shadow.scaleY=.4}__extends(e,t);var i=(__define,e),n=i.prototype;return n.show=function(){var t=this;this.shadow.alpha=1,egret.Tween.get(this.shadow).to({alpha:0},2e3).call(function(){t.parent.removeChild(t),e.shadows.push(t)},this)},e.shadows=[],e}(egret.DisplayObjectContainer);t.Shadow=i,egret.registerClass(i,"one.Shadow")}(one||(one={}));var one;!function(t){var e=function(t){function e(){t.call(this),this.fireInterval=100,this.bulletId=0,this.bulletSpeed=0}__extends(e,t);var i=(__define,e),n=i.prototype;return n.initCfg=function(e){t.prototype.initCfg.call(this,e),this.bulletId=e.bullet.id,this.bulletSpeed=e.bullet.speed},e}(tank.BaseVO);t.RoleVO=e,egret.registerClass(e,"one.RoleVO")}(one||(one={}));var one;!function(t){var e=function(e){function i(){e.call(this,tank.BaseVO,21,t.SideType.NEUTRAL)
}__extends(i,e);var n=(__define,i),s=n.prototype;return s.setStepX=function(t){},s.setStepY=function(t){},i}(tank.BaseItem);t.Stone=e,egret.registerClass(e,"one.Stone")}(one||(one={}));var MapTest=function(t){function e(){t.call(this),this.once(egret.Event.ADDED_TO_STAGE,this.init,this)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.init=function(t){this.mapProxy=new one.MapProxy,this.mapProxy.analysis({width:400,height:400});var e=new one.MapItemVO,i=new one.BlockVO(0,0,50,50);e.setBlocks([i]),e.x=-20,e.y=-20,this.mapProxy.buildAdd(e),this.traceGrids(),e.x+=30,e.y+=30,this.mapProxy.buildRefresh(e),this.traceGrids(),e.x+=90,e.y+=90,this.mapProxy.buildRefresh(e),this.traceGrids(),i.width+=90,i.height+=90,this.mapProxy.buildRefresh(e),this.traceGrids(),this.mapProxy.buildRemove(e),this.traceGrids();var n=new one.Map(this.stage.stageWidth,this.stage.stageHeight);this.addChild(n),n.init(),one.OptionCtr.getInstance().init(this)},n.traceGrids=function(){for(var t=this.mapProxy.mapVO.enemyGrids,e=0;e<t.length;e++)for(var i=0;t[e]&&i<t[e].length;i++)console.log(e+" 222 "+t[e][i].toString())},e}(egret.DisplayObjectContainer);egret.registerClass(MapTest,"MapTest");