var LoadingUI=function(t){function e(){t.call(this),this.createView()}__extends(e,t);var i=(__define,e),n=i.prototype;return n.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},n.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},n.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},n.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},n.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},n.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},n.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},n.createGameScene=function(){var t=new MapTest;this.addChild(t)},e}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var one;!function(t){function e(t,e){return Math.floor(Math.random()*(e-t+1))+t}t.randomInt=e}(one||(one={}));var one;!function(t){var e=function(t){function e(){t.call(this)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.execute=function(t){var e=puremvc.Facade.getInstance("Map"),t=new puremvc.Notification("CREATE_BULLET",t.getBody());e.notifyObservers(t)},e}(puremvc.SimpleCommand);t.CreateBulletCMD=e,egret.registerClass(e,"one.CreateBulletCMD")}(one||(one={}));var one;!function(t){var e=function(e){function i(){e.call(this)}__extends(i,e);var n=(__define,i),s=n.prototype;return s.execute=function(e){this.facade().retrieveProxy(t.MapVO.NAME)},i}(puremvc.SimpleCommand);t.MapInitCommand=e,egret.registerClass(e,"one.MapInitCommand")}(one||(one={}));var one;!function(t){t.BUTTONS=[10,11,12,13,14,15,16,17]}(one||(one={}));var one;!function(t){var e=function(e){function i(){var t=this;e.call(this),this.isLeft=!1,this.isUp=!1,this.isRight=!1,this.isDown=!1,this.mapButtons={},this.downKeys=[],this.onDown=function(e){var n=e.keyCode,s=t.mapButtons[n];if(s){var o=t.downKeys.indexOf(s);if(o>=0)return;t.downKeys.push(s)}else switch(n){case i.leftCode:t.isLeft=!0;break;case i.upCode:t.isUp=!0;break;case i.rightCode:t.isRight=!0;break;case i.downCode:t.isDown=!0;break;default:return}t.onChange()},this.onUp=function(e){var n=e.keyCode,s=t.mapButtons[n];if(s){var o=t.downKeys.indexOf(s);if(!(o>=0))return;t.downKeys.splice(o,1)}else switch(n){case i.leftCode:t.isLeft=!1;break;case i.upCode:t.isUp=!1;break;case i.rightCode:t.isRight=!1;break;case i.downCode:t.isDown=!1;break;default:return}t.onChange()}}__extends(i,e);var n=(__define,i),s=n.prototype;return s.init=function(e,n){i.upCode=e[0],i.downCode=e[1],i.leftCode=e[2],i.rightCode=e[3],this.buttons=n;for(var s=0;s<n.length;s++)this.mapButtons[n[s]]=t.BUTTONS[s];window.addEventListener("keydown",this.onDown),window.addEventListener("keyup",this.onUp)},s.onChange=function(){var e=[];this.isUp?this.isDown||e.push(2):this.isDown&&e.push(3),this.isLeft?this.isRight||e.push(0):this.isRight&&e.push(1),t.OptionEvent.dispatchOptionEvent(this,t.OptionEvent.OPTION_CHANGE,e,this.downKeys)},i.leftCode=65,i.upCode=87,i.rightCode=68,i.downCode=83,i}(egret.EventDispatcher);t.KeyBoardCtr=e,egret.registerClass(e,"one.KeyBoardCtr")}(one||(one={}));var one;!function(t){var e=function(e){function i(){e.call(this),this.keyCtr=new t.KeyBoardCtr,this.touchCtr=new t.TouchCtr}__extends(i,e);var n=(__define,i),s=n.prototype;return s.init=function(e){this.keyCtr.init([87,83,65,68],[74,75]),this.touchCtr.init(e),this.keyCtr.addEventListener(t.OptionEvent.OPTION_CHANGE,this.onHander,this),this.touchCtr.addEventListener(t.OptionEvent.OPTION_CHANGE,this.onHander,this)},s.onHander=function(t){this.dispatchEvent(t)},s.start=function(){},s.stop=function(){},i.getInstance=function(){return null==i.instance&&(i.instance=new i),i.instance},i}(egret.EventDispatcher);t.OptionCtr=e,egret.registerClass(e,"one.OptionCtr")}(one||(one={}));var one;!function(t){var e=function(t){function e(e){t.call(this,e)}__extends(e,t);var i=(__define,e);i.prototype;return e.dispatchOptionEvent=function(t,i,n,s){if(!t.hasEventListener(i))return!0;var o=egret.Event.create(e,i);o.directions=n,o.buttons=s;var r=t.dispatchEvent(o);return egret.Event.release(o),r},e.OPTION_CHANGE="optionChange",e}(egret.Event);t.OptionEvent=e,egret.registerClass(e,"one.OptionEvent")}(one||(one={}));var one;!function(t){var e=function(e){function i(){var t=this;e.call(this),this.dicX=0,this.dicY=0,this.dicR=80,this.btnX=0,this.btnY=0,this.btnR=80,this.horizontalDirect=0,this.verticalDirect=0,this.horizontalBtn=0,this.verticalBtn=0,this.dircPointID=0,this.btnPointID=0,this.onMove=function(e){e.touchPointID>0?t.dircPointID==e.touchPointID?t.setDirection(e.localX,e.localY):t.btnPointID==e.touchPointID&&t.setBtn(e.localX,e.localY):t.dircPointID>0?t.setDirection(e.localX,e.localY):t.setBtn(e.localX,e.localY)},this.onDown=function(e){t.isInDirection(e.localX,e.localY)&&0==t.dircPointID&&(t.dircPointID=Math.max(e.touchPointID,1),t.setDirection(e.localX,e.localY)),t.isInButton(e.localX,e.localY)&&0==t.btnPointID&&(t.btnPointID=Math.max(e.touchPointID,1),t.setBtn(e.localX,e.localY))},this.onUp=function(e){e.touchPointID>0?t.dircPointID==e.touchPointID?(t.verticalDirect=0,t.horizontalDirect=0,t.dircPointID=0,t.onChange()):t.btnPointID==e.touchPointID&&(t.verticalBtn=0,t.horizontalBtn=0,t.btnPointID=0,t.onChange()):(t.verticalDirect=0,t.horizontalDirect=0,t.dircPointID=0,t.verticalBtn=0,t.horizontalBtn=0,t.btnPointID=0,t.onChange())}}__extends(i,e);var n=(__define,i),s=n.prototype;return s.init=function(t){var e=1.2*this.dicR;this.dicX=e,this.dicY=t.stage.stageHeight-e;var i=new egret.Shape;i.graphics.beginFill(16711680),i.graphics.drawCircle(this.dicR,this.dicR,this.dicR),i.graphics.endFill(),t.addChild(i),i.x=this.dicX-this.dicR,i.y=this.dicY-this.dicR,this.btnX=t.stage.$stageWidth-e,this.btnY=t.stage.stageHeight-e;var i=new egret.Shape;i.graphics.beginFill(16711680),i.graphics.drawCircle(this.btnR,this.btnR,this.btnR),i.graphics.endFill(),t.addChild(i),i.x=this.btnX-this.btnR,i.y=this.btnY-this.btnR,t.touchEnabled=!0,t.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onDown,this),t.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onMove,this),t.addEventListener(egret.TouchEvent.TOUCH_END,this.onUp,this),t.addEventListener(egret.TouchEvent.TOUCH_CANCEL,this.onUp,this),t.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onUp,this)},s.isInButton=function(t,e){return this.isInCircle(this.btnX,this.btnY,t,e,2*this.btnR)},s.isInDirection=function(t,e){return this.isInCircle(this.dicX,this.dicY,t,e,2*this.dicR)},s.isInCircle=function(t,e,i,n,s){return s*s>(t-i)*(t-i)+(e-n)*(e-n)},s.setDirection=function(t,e){var i=!1,n=0;t>this.dicX+this.dicR/2?n=1:t<this.dicX-this.dicR/2&&(n=-1),this.horizontalDirect!=n&&(i=!0,this.horizontalDirect=n);var n=0;e>this.dicY+this.dicR/2?n=1:e<this.dicY-this.dicR/2&&(n=-1),this.verticalDirect!=n&&(i=!0,this.verticalDirect=n),i&&this.onChange()},s.setBtn=function(t,e){var i=!1,n=0;t>this.btnX+this.btnR/2?n=1:t<this.btnX-this.btnR/2&&(n=-1),this.horizontalBtn!=n&&(i=!0,this.horizontalBtn=n);var n=0;e>this.btnY+this.btnR/2?n=1:e<this.btnY-this.btnR/2&&(n=-1),this.verticalBtn!=n&&(i=!0,this.verticalBtn=n),i&&this.onChange()},s.onChange=function(){var e=[];this.horizontalBtn>0?(e.push(t.BUTTONS[0]),e.push(t.BUTTONS[1])):this.verticalBtn<0?e.push(t.BUTTONS[1]):this.verticalBtn>0&&e.push(t.BUTTONS[0]);var i=[];this.verticalDirect<0?i.push(2):this.verticalDirect>0&&i.push(3),this.horizontalDirect<0?i.push(0):this.horizontalDirect>0&&i.push(1),t.OptionEvent.dispatchOptionEvent(this,t.OptionEvent.OPTION_CHANGE,i,e)},i}(egret.EventDispatcher);t.TouchCtr=e,egret.registerClass(e,"one.TouchCtr")}(one||(one={}));var Effect=function(t){function e(e,i,n,s,o){t.call(this),this.skeletonData=e,this.textureData=i,this.texture=n,this.armatureName=s,this.animationName=o}__extends(e,t);var i=(__define,e),n=i.prototype;return n.initRoot=function(){var t=this,e=new egret.DisplayObjectContainer;this.addChild(e);var i=new dragonBones.EgretFactory;i.addSkeletonData(dragonBones.DataParser.parseDragonBonesData(this.skeletonData)),i.addTextureAtlas(new dragonBones.EgretTextureAtlas(this.texture,this.textureData));var n=i.buildArmature(this.armatureName),s=n.getDisplay();dragonBones.WorldClock.clock.add(n),e.addChild(s),n.animation.gotoAndPlay(this.animationName,0),n.addEventListener(dragonBones.AnimationEvent.COMPLETE,function(e){dragonBones.WorldClock.clock.remove(n),t.dispatchEvent(e),t.parent.removeChild(t)},this)},e.start=function(){egret.Ticker.getInstance().register(function(t){return dragonBones.WorldClock.clock.advanceTime(t/1e3),!0},this)},e}(egret.DisplayObjectContainer);egret.registerClass(Effect,"Effect");var one;!function(t){var e=function(){function t(){this.width=0,this.height=0}var e=(__define,t),i=e.prototype;return i.toString=function(){return"width:"+this.width+" height:"+this.height+" centerX:"+this.centerX+" centerY:"+this.centerY+" type:"+this.type},t}();t.GridVO=e,egret.registerClass(e,"one.GridVO")}(one||(one={}));var one;!function(t){var e=function(t){function e(e){t.call(this),this.vo=new e,this.vo.item=this}__extends(e,t);var i=(__define,e);i.prototype;return e}(egret.DisplayObjectContainer);t.MapItem=e,egret.registerClass(e,"one.MapItem")}(one||(one={}));var one;!function(t){var e=function(){function t(){}var e=(__define,t);e.prototype;return t.BUILD=1,t.BULLET=2,t}();t.ItemType=e,egret.registerClass(e,"one.ItemType");var i=function(){function t(){}var e=(__define,t);e.prototype;return t.FRIEND=1,t.ENEMY=-1,t.NEUTRAL=0,t}();t.SideType=i,egret.registerClass(i,"one.SideType");var n=function(){function t(){this.offX=0,this.offY=0,this.minX=0,this.minY=0,this.maxX=0,this.maxY=0,this.x=0,this.y=0,this.rotation=0,this.realBlockSizes=[],this._hashId=t.hashCount++}var e=__define,i=t,n=i.prototype;return n.setBlocks=function(t){this.blockSizes=t,this.changeRotation(this.rotation)},n.toString=function(){return"x:"+this.x+" y:"+this.y+" buildId:"+this.buildId},e(n,"hashId",function(){return this._hashId}),n.getBlockSizes=function(){return this.realBlockSizes},n.changeRotation=function(t){this.realBlockSizes=[];for(var e=0;e<this.blockSizes.length;e++){var i=this.blockSizes[e];this.setBlock(i.x,i.y,i.width,i.height,t)}},n.setBlock=function(t,e,i,n,s){switch((s+360)%360){case 0:return void this.realBlockSizes.push({x:t,y:e,width:i,height:n});case 180:return void this.realBlockSizes.push({x:-t,y:-e,width:i,height:n});case 90:return void this.realBlockSizes.push({x:-e,y:t,width:n,height:i});case 270:return void this.realBlockSizes.push({x:e,y:-t,width:n,height:i})}var o=Math.acos(e);t>0&&(o=2*Math.PI-o);var r=Math.abs(t/Math.sin(o)),a=o+s/180*Math.PI;this.realBlockSizes.push({x:r*Math.sin(a),y:r*Math.cos(a),width:i,height:n})},t.hashCount=1,t}();t.MapItemVO=n,egret.registerClass(n,"one.MapItemVO");var s=function(){function t(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n}var e=(__define,t);e.prototype;return t}();t.BlockVO=s,egret.registerClass(s,"one.BlockVO")}(one||(one={}));var one;!function(t){var e=function(){function e(){this.minSize=10,this.gridWidth=100,this.gridHeight=100,this.totalX=0,this.totalY=0}var i=(__define,e),n=i.prototype;return n.getBuildVO=function(t){return this.mapVO.builds[t]?this.mapVO.builds[t].vo:null},n.getIndex=function(t,e){return t=Math.max(Math.min(t,this.totalX),0),e=Math.max(Math.min(e,this.totalY),0),this.totalX*e+t},n.analysis=function(e){this.mapVO=new t.MapVO;var i=e.width,n=e.height;this.totalX=Math.floor(i/this.gridWidth)+1,this.totalY=Math.floor(n/this.gridHeight)+1},n.buildAdd=function(t){this.addBuildVO(t)},n.getGridsArr=function(e,i){switch(e){case t.ItemType.BUILD:return i==t.SideType.ENEMY?this.mapVO.enemyGrids:i==t.SideType.FRIEND?this.mapVO.friendGrids:this.mapVO.neutralGrids;case t.ItemType.BULLET:return i==t.SideType.ENEMY?this.mapVO.enemyBullets:i==t.SideType.FRIEND?this.mapVO.friendBullets:this.mapVO.neutralBullets;default:return this.mapVO.friendGrids}},n.addBuildVO=function(t){this.mapVO.builds[t.hashId]={vo:t,grids:[]};for(var e=t.getBlockSizes(),i=0;i<e.length;i++){var n=e[i];this.addOneSize(n.x+t.x,n.y+t.y,n.width,n.height,t.type,t.side,t.hashId)}},n.getAreaIds=function(t,e,i,n){var n=n>0?n:i,s=t-i/2,o=e-n/2,r=Math.floor(s/this.gridWidth),a=Math.floor(o/this.gridHeight);r=Math.max(r,0),a=Math.max(a,0);var h=Math.floor((s+i)/this.gridWidth),d=Math.floor((o+n)/this.gridHeight);h=Math.min(h,this.totalX),d=Math.min(d,this.totalY);for(var c=[],u=r;h>=u;u++)for(var l=a;d>=l;l++)c.push(this.getIndex(u,l));return c},n.addOneSize=function(e,i,n,s,o,r,a){var h=new t.GridVO;h.centerX=e,h.centerY=i,h.width=n,h.height=s,h.hashId=a,h.side=r,this.mapVO.builds[a].grids.push(h);for(var d=this.getAreaIds(e,i,n,s),c=0;c<d.length;c++){var u=d[c],l=this.getGridsArr(o,r);null==l[u]&&(l[u]=[]),l[u].push(h)}},n.buildRemove=function(t){this.removeBuildVO(t)},n.buildRefresh=function(t){this.removeBuildVO(t),this.addBuildVO(t)},n.removeBuildVO=function(t){if(this.mapVO.builds[t.hashId]){for(var e=this.getGridsArr(t.type,t.side),i=this.mapVO.builds[t.hashId].grids,n=0;n<i.length;n++)for(var s=i[n],o=this.getAreaIds(s.centerX,s.centerY,s.width,s.height),r=0;r<o.length;r++){var a=e[o[r]],h=a.indexOf(s);h>=0&&a.splice(h,1)}return this.mapVO.builds[t.hashId]=null,!0}return!1},n.getBlockArr=function(e,i){var n=[];switch(e){case t.ItemType.BUILD:n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.FRIEND)),n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.ENEMY)),n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.NEUTRAL));break;case t.ItemType.BULLET:i!=t.SideType.FRIEND&&(n.push(this.getGridsArr(t.ItemType.BULLET,t.SideType.FRIEND)),n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.FRIEND))),i!=t.SideType.ENEMY&&(n.push(this.getGridsArr(t.ItemType.BULLET,t.SideType.ENEMY)),n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.ENEMY))),i!=t.SideType.NEUTRAL&&(n.push(this.getGridsArr(t.ItemType.BULLET,t.SideType.NEUTRAL)),n.push(this.getGridsArr(t.ItemType.BUILD,t.SideType.NEUTRAL)))}return n},n.isBlocked=function(t,e,i,n,s,o){for(var r=0;r<i.length;r++){var a=i[r],h=this.isBlocked111111(a.x+t,a.y+e,a.width,a.height,n,s,o);if(0!=h)return h}return 0},n.isBlocked111111=function(t,e,i,n,s,o,r){for(var a=this.getAreaIds(t,e,i,n),h=this.getBlockArr(s,o),d=0;d<a.length;d++)for(var c=0;c<h.length;c++)for(var u=h[c][a[d]],l=0;u&&l<u.length;l++){var p=u[l];if(r!=p.hashId&&this.isCoincident(t,e,i,n,p.centerX,p.centerY,p.width,p.height))return p.hashId}return 0},n.isCoincident=function(t,e,i,n,s,o,r,a){return 0==n?0==a?this.isTwoCircleCoincident(t,e,i,s,o,r):this.isRectAndCircleCoincident(s,o,r,a,t,e,i):0==a?this.isRectAndCircleCoincident(t,e,i,n,s,o,r):this.isTwoRectCoincident(t,e,i,n,s,o,r,a)},n.isRectAndCircleCoincident=function(t,e,i,n,s,o,r){return Math.abs(t-s)<=(i+r)/2&&Math.abs(e-o)<=(n+r)/2},n.isTwoRectCoincident=function(t,e,i,n,s,o,r,a){return Math.abs(t-s)<=(i+r)/2&&Math.abs(e-o)<=(n+a)/2},n.isTwoCircleCoincident=function(t,e,i,n,s,o){return(i+o)*(i+o)/4>=(t-n)*(t-n)+(e-s)*(e-s)},e}();t.MapProxy=e,egret.registerClass(e,"one.MapProxy")}(one||(one={}));var one;!function(t){var e=function(){function t(){this.friendGrids=[],this.enemyGrids=[],this.neutralGrids=[],this.friendBullets=[],this.enemyBullets=[],this.neutralBullets=[],this.builds={}}var e=(__define,t);e.prototype;return t.NAME="mapVO",t}();t.MapVO=e,egret.registerClass(e,"one.MapVO")}(one||(one={}));var one;!function(t){var e=function(e){function i(i,n){e.call(this),this.minX=0,this.minY=0,this.maxX=0,this.maxY=0,this.minX=0,this.minY=0,this.maxX=i,this.maxY=n;var s=puremvc.Facade.getInstance("Map");s.registerCommand("CreateBullet",t.CreateBulletCMD);var o=new MapMediator(this);s.registerMediator(o),this.groundLayer=new egret.DisplayObjectContainer,this.roleLayer=new egret.DisplayObjectContainer,this.bulletLayer=new egret.DisplayObjectContainer,this.effectLayer=new egret.DisplayObjectContainer,this.addChild(this.groundLayer),this.addChild(this.roleLayer),this.addChild(this.bulletLayer),this.addChild(this.effectLayer)}__extends(i,e);var n=(__define,i),s=n.prototype;return s.init=function(){this.mapProxy=new t.MapProxy,this.mapProxy.analysis({width:800,height:480});for(var e=0;20>e;e++){var i=new t.Enemy;this.roleLayer.addChild(i),i.vo.x=120*(e%7)+30,i.vo.y=120*Math.floor(e/7)+30,this.mapProxy.buildAdd(i.vo)}for(var e=0;20>e;e++){var n=new t.Stone;this.roleLayer.addChild(n),n.vo.x=120*(e%7)+30,n.vo.y=120*Math.floor(e/7)+30+60,this.mapProxy.buildAdd(n.vo),n.updateView()}var s=this.role=new t.Role;this.roleLayer.addChild(s),s.vo.x=700,s.vo.y=200,this.mapProxy.buildAdd(s.vo),s.init(),s.updateView(),egret.startTick(this.loop,this),egret.setInterval(function(){},this,5e3),Effect.start()},s.createBullet=function(){var e=new t.Bullet(t.SideType.FRIEND);this.addChild(e),e.vo.x=this.role.x+this.role.width/2,e.vo.y=this.role.y+this.role.height/2,e.setStepX(this.role.getDicX()),e.setStepY(this.role.getDicY())},s.addBullet=function(t){this.bulletLayer.addChild(t),this.mapProxy.buildAdd(t.vo)},s.addToGround=function(t){this.groundLayer.addChild(t)},s.addRole=function(){},s.loop=function(e){for(var i=0;i<this.roleLayer.numChildren;i++){var n=this.roleLayer.getChildAt(i);this.mapProxy.getBuildVO(n.vo.hashId)&&(n instanceof t.Stone||n.vo.type==t.ItemType.BUILD&&(0!=n.getStepX()||0!=n.getStepY()?this.mapProxy.isBlocked(n.vo.x+n.getStepX(),n.vo.y+n.getStepY(),n.vo.getBlockSizes(),n.vo.type,n.vo.side,n.vo.hashId)?this.mapProxy.isBlocked(n.vo.x+n.getStepX(),n.vo.y,n.vo.getBlockSizes(),n.vo.type,n.vo.side,n.vo.hashId)?this.mapProxy.isBlocked(n.vo.x,n.vo.y+n.getStepY(),n.vo.getBlockSizes(),n.vo.type,n.vo.side,n.vo.hashId)||(n.updateY(),n.updateStep(),n.vo.y=Math.min(Math.max(n.vo.y,this.minY+n.vo.minY),this.maxY-n.vo.maxY),this.mapProxy.buildRefresh(n.vo),n.updateView()):(n.updateX(),n.updateStep(),n.vo.x=Math.min(Math.max(n.vo.x,this.minX+n.vo.minX),this.maxX-n.vo.maxX),this.mapProxy.buildRefresh(n.vo),n.updateView()):(n.updateX(),n.updateY(),n.updateStep(),n.vo.x=Math.min(Math.max(n.vo.x,this.minX+n.vo.minX),this.maxX-n.vo.maxX),n.vo.y=Math.min(Math.max(n.vo.y,this.minY+n.vo.minY),this.maxY-n.vo.maxY),this.mapProxy.buildRefresh(n.vo),n.updateView()):n.updateStep()))}for(var i=0;i<this.bulletLayer.numChildren;i++){var n=this.bulletLayer.getChildAt(i);if(this.mapProxy.getBuildVO(n.vo.hashId)&&n.vo.type==t.ItemType.BULLET){var s=this.mapProxy.isBlocked(n.vo.x+n.getStepX(),n.vo.y+n.getStepY(),n.vo.getBlockSizes(),n.vo.type,n.vo.side,n.vo.hashId);if(s){var o=this.mapProxy.getBuildVO(s),r=o.item,a=RES.getRes("baozhaxiaoguo_ske_json"),h=RES.getRes("baozhaxiaoguo_texture_json"),d=RES.getRes("baozhaxiaoguo_texture_png"),c=new Effect(a,h,d,"baozha","baozha");c.initRoot(),c.x=r.x,c.y=r.y,c.scaleX=c.scaleY=.4,this.effectLayer.addChild(c),r.setStepX(0),r.setStepY(0),r.attack(),this.mapProxy.buildRemove(o)}else n.updateX(),n.updateY(),n.updateStep(),n.vo.x+n.vo.maxY<this.minX||n.vo.x-n.vo.minY>this.maxX||n.vo.y+n.vo.maxY<this.minY||n.vo.y-n.vo.minY>this.maxY?(n.attack(),this.mapProxy.buildRemove(n.vo)):(this.mapProxy.buildRefresh(n.vo),n.updateView())}}return!1},i}(egret.DisplayObjectContainer);t.Map=e,egret.registerClass(e,"one.Map")}(one||(one={}));var MapMediator=function(t){function e(i){t.call(this,e.NAME,i)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.listNotificationInterests=function(){return["CREATE_BULLET","ADD_TO_GROUND"]},n.handleNotification=function(t){if("CREATE_BULLET"==t.getName()){var e=this.getViewComponent();e.addBullet(t.getBody())}if("ADD_TO_GROUND"==t.getName()){var e=this.getViewComponent();e.addToGround(t.getBody())}},e.NAME="MapMediator",e}(puremvc.Mediator);egret.registerClass(MapMediator,"MapMediator");var yjtx;!function(t){function e(e,i){e>0&&t.totalX+e>t.currentRoad.endX}t.run=e;var i=function(){function t(){}var e=(__define,t);e.prototype;return t}();t.Roads=i,egret.registerClass(i,"yjtx.Roads");var n=function(){function t(){}var e=(__define,t);e.prototype;return t}();t.RoadPoint=n,egret.registerClass(n,"yjtx.RoadPoint")}(yjtx||(yjtx={}));var one;!function(t){function e(t){switch(t){case 2:return{name:"enemy_png"};case 11:return{name:"bullet_png"};case 12:return{name:"bullet2_png"};case 21:return{name:"stone_png"};case 101:return{name:"tank",armature:"myTank",animation:"walk"};default:return{name:"hero_png"}}}var i=function(t){function i(i,n,s){t.call(this);var o=e(i);o.armature?(this.init(RES.getRes(o.name+"_ske_json"),RES.getRes(o.name+"_texture_json"),RES.getRes(o.name+"_texture_png"),o.armature,o.animation),this.movie.scaleX=this.movie.scaleY=.4):(this.movie=new egret.Bitmap(RES.getRes(o.name)),this.addChild(this.movie),this.movie.width=n,this.movie.height=s,this.movie.anchorOffsetX=this.movie.width/2,this.movie.anchorOffsetY=this.movie.height/2)}__extends(i,t);var n=(__define,i),s=n.prototype;return s.changeAnimation=function(t){this.armature.animation.gotoAndPlay(t,0)},s.init=function(t,e,i,n,s){var o=new dragonBones.EgretFactory;o.addSkeletonData(dragonBones.DataParser.parseDragonBonesData(t)),o.addTextureAtlas(new dragonBones.EgretTextureAtlas(i,e));var r=this.armature=o.buildArmature(n),a=this.movie=r.getDisplay();dragonBones.WorldClock.clock.add(r),this.addChild(a),r.animation.gotoAndPlay(s,0);var h=this;r.addEventListener(dragonBones.AnimationEvent.COMPLETE,function(t){h.dispatchEvent(t)},this),r.addEventListener(dragonBones.FrameEvent.ANIMATION_FRAME_EVENT,function(t){h.dispatchEvent(t)},this),r.addEventListener(dragonBones.FrameEvent.MOVEMENT_FRAME_EVENT,function(t){h.dispatchEvent(t)},this)},i}(egret.DisplayObjectContainer);t.Anmiation=i,egret.registerClass(i,"one.Anmiation")}(one||(one={}));var one;!function(t){var e=function(e){function i(i,n,s,o,r){e.call(this,t.RoleVO),this._stepX=0,this._stepY=0,this._speed=1,this._turningTime=0,this.vo.buildId=i,this.vo.setBlocks([new t.BlockVO(0,0,n,s)]),this.vo.side=r,this.vo.type=o,this.view=new t.Anmiation(i,n,s),this.addChild(this.view),this.vo.minX=n/2,this.vo.minY=s/2,this.vo.maxX=n/2,this.vo.maxY=s/2,this._dicX=0,this._dicY=1}__extends(i,e);var n=(__define,i),s=n.prototype;return s.getStepX=function(){return this._stepX*this._speed},s.getStepY=function(){return this._stepY*this._speed},s.setStepX=function(t){this._stepX=t},s.setStepY=function(t){this._stepY=t},s.updateX=function(){this._turningTime>0||(this.vo.x+=this._stepX*this._speed)},s.updateY=function(){this._turningTime>0||(this.vo.y+=this._stepY*this._speed)},s.updateStep=function(){return this._turningTime>0?void this._turningTime--:void 0},s.updateView=function(){this.x=this.vo.x,this.y=this.vo.y},s.getDicX=function(){return this._dicX},s.getDicY=function(){return this._dicY},s.changeDic=function(t,e){this._stepX=t,this._stepY=e;var i=0;0!=t?(this._dicX=t,this._dicY=e,i=0==e?90*-t:1==e?135/(t+2)+45*(e+1)+180:45*t+45*(e+1)+180):0!=e?(this._dicY=e,this._dicX=0,i=90*(e+1)+180):i=this.view.rotation,this.view.rotation=i,this.vo.changeRotation(i)},s.attack=function(){egret.setTimeout(function(){this.parent.removeChild(this)},this,100)},i}(t.MapItem);t.BaseRole=e,egret.registerClass(e,"one.BaseRole")}(one||(one={}));var one;!function(t){var e=function(e){function i(i){e.call(this,12,32,96,t.ItemType.BULLET,i),this.vo.setBlocks([new t.BlockVO(0,0,32,32),new t.BlockVO(0,32,32,32),new t.BlockVO(0,-32,32,32)]),this._speed=0}__extends(i,e);var n=(__define,i),s=n.prototype;return s.fire=function(){this._speed=1;var t=RES.getRes("launcher_ske_json"),e=RES.getRes("launcher_texture_json"),i=RES.getRes("launcher_texture_png"),n=new Effect(t,e,i,"launcher","start");n.initRoot(),n.scaleX=n.scaleY=.4,this.addChild(n),n.addEventListener(dragonBones.AnimationEvent.COMPLETE,function(t){this._speed=6},this)},s.attack=function(){null==this.parent&&console.log(this.vo.hashId),egret.setTimeout(function(){this.parent.removeChild(this)},this,100)},i}(t.BaseRole);t.Bullet=e,egret.registerClass(e,"one.Bullet")}(one||(one={}));var one;!function(t){var e=function(e){function i(){e.call(this,2,40,40,t.ItemType.BUILD,t.SideType.ENEMY),this._deltaThinkTime=0,this._thinkInterval=20,this._deltaFireTime=0,this._fireInterval=20}__extends(i,e);var n=(__define,i),s=n.prototype;return s.updateStep=function(){e.prototype.updateStep.call(this),this.think(),this.checkFire()},s.think=function(){if(this._deltaThinkTime++,this._deltaThinkTime>=this._thinkInterval){this._deltaThinkTime=0,this._thinkInterval=t.randomInt(105,400);var e=t.randomInt(-2,2),i=0,n=0;switch(e){case 2:case-2:n=e/2;break;case 1:case-1:i=e}(this._stepX!=i||this._stepY!=n)&&(this._turningTime=2),this.changeDic(i,n)}},s.checkFire=function(){this._deltaFireTime++,this._deltaFireTime>=this._fireInterval&&(this._deltaFireTime=0,this._fireInterval=t.randomInt(205,600),this.fire())},s.fire=function(){return},i}(t.BaseRole);t.Enemy=e,egret.registerClass(e,"one.Enemy")}(one||(one={}));var one;!function(t){var e=function(e){function n(){e.call(this,101,40,40,t.ItemType.BUILD,t.SideType.FRIEND),this.isAttack=!1,this.isJump=!1,this.fireCount=0,this.shadowCount=30,this.shadowTimes=15,this._speed=2}__extends(n,e);var s=(__define,n),o=s.prototype;return o.init=function(){var e=this,i=function(i){for(var n=i.directions,s=0,o=0,r=0;r<n.length;r++)switch(n[r]){case 0:s--;break;case 1:s++;break;case 2:o--;break;case 3:o++}0==e._stepX&&0==e._stepY&&(e._turningTime=6),e.changeDic(s,o),e.isAttack=!1,e.isJump=!1;var a=i.buttons;for(r=0;r<a.length;r++)switch(a[r]){case t.BUTTONS[0]:e.isAttack=!0;break;case t.BUTTONS[1]:e.isJump=!0}};t.OptionCtr.getInstance().addEventListener(t.OptionEvent.OPTION_CHANGE,i,this)},o.createBullet=function(){var e=new t.Bullet(t.SideType.FRIEND),i=this.view.localToGlobal(0,20);e.vo.x=i.x,e.vo.y=i.y,e.changeDic(this.getDicX(),this.getDicY()),e.updateView();var n=puremvc.Facade.getInstance("Map");n.sendNotification("CREATE_BULLET",e),e.fire(),this.view.changeAnimation("attack"),this.view.addEventListener(dragonBones.AnimationEvent.COMPLETE,function(t){this.view.changeAnimation("\bwalk")},this)},o.updateStep=function(){if(e.prototype.updateStep.call(this),this.fireCount<=0?this.isAttack&&(this.fireCount=this.vo.fireInterval,this.createBullet()):this.fireCount--,this.shadowCount++,this.shadowCount>=this.shadowTimes){this.shadowCount=0;var t=this.getShadow();t.rotation=this.view.rotation,t.x=this.x,t.y=this.y,t.show();var i=puremvc.Facade.getInstance("Map");i.sendNotification("ADD_TO_GROUND",t)}},o.getShadow=function(){if(i.shadows.length)return i.shadows.pop();var t=new i;return t},o.jump=function(){},o.run=function(){},o.down=function(){},o.setDic=function(t,e){},n}(t.BaseRole);t.Role=e,egret.registerClass(e,"one.Role");var i=function(t){function e(){t.call(this),this.shadow=new egret.Bitmap(RES.getRes("shadow_png")),this.addChild(this.shadow),this.shadow.anchorOffsetX=this.shadow.width/2,this.shadow.anchorOffsetY=this.shadow.height/2,this.shadow.scaleX=this.shadow.scaleY=.4}__extends(e,t);var i=(__define,e),n=i.prototype;return n.show=function(){var t=this;this.shadow.alpha=1,egret.Tween.get(this.shadow).to({alpha:0},2e3).call(function(){t.parent.removeChild(t),e.shadows.push(t)},this)},e.shadows=[],e}(egret.DisplayObjectContainer);t.Shadow=i,egret.registerClass(i,"one.Shadow")}(one||(one={}));var one;!function(t){var e=function(t){function e(){t.call(this),this.fireInterval=100}__extends(e,t);var i=(__define,e);i.prototype;return e}(t.MapItemVO);t.RoleVO=e,egret.registerClass(e,"one.RoleVO")}(one||(one={}));var one;!function(t){var e=function(e){function i(){e.call(this,t.MapItemVO),this.vo.buildId=21;var i=40;this.vo.setBlocks([new t.BlockVO(0,0,i,i)]),this.vo.side=t.SideType.NEUTRAL,this.vo.type=t.ItemType.BUILD,this.view=new t.Anmiation(this.vo.buildId,i,i),this.addChild(this.view)}__extends(i,e);var n=(__define,i),s=n.prototype;return s.setStepX=function(t){},s.setStepY=function(t){},s.updateView=function(){this.x=this.vo.x,this.y=this.vo.y},s.attack=function(){this.parent.removeChild(this)},i}(t.MapItem);t.Stone=e,egret.registerClass(e,"one.Stone")}(one||(one={}));var MapTest=function(t){function e(){t.call(this),this.once(egret.Event.ADDED_TO_STAGE,this.init,this)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.init=function(t){this.mapProxy=new one.MapProxy,this.mapProxy.analysis({width:400,height:400});var e=new one.MapItemVO;e.buildId=1;var i=new one.BlockVO(0,0,50,50);e.setBlocks([i]),e.x=-20,e.y=-20,this.mapProxy.buildAdd(e),this.traceGrids(),e.x+=30,e.y+=30,this.mapProxy.buildRefresh(e),this.traceGrids(),e.x+=90,e.y+=90,this.mapProxy.buildRefresh(e),this.traceGrids(),i.width+=90,i.height+=90,this.mapProxy.buildRefresh(e),this.traceGrids(),this.mapProxy.buildRemove(e),this.traceGrids();var n=new one.Map(this.stage.stageWidth,this.stage.stageHeight);this.addChild(n),n.init(),one.OptionCtr.getInstance().init(this)},n.traceGrids=function(){for(var t=this.mapProxy.mapVO.enemyGrids,e=0;e<t.length;e++)for(var i=0;t[e]&&i<t[e].length;i++)console.log(e+" 222 "+t[e][i].toString())},e}(egret.DisplayObjectContainer);egret.registerClass(MapTest,"MapTest");